# æ•°æ®åº“æ¶æ„è®¾è®¡

> æœ¬æ–‡æ¡£åˆ†æäº†JinBeané¡¹ç›®ä¸­æ•°æ®åº“æ¶æ„çš„è®¾è®¡å†³ç­–ï¼ŒåŒ…æ‹¬å•æ•°æ®åº“å®ä¾‹vså¤šæ•°æ®åº“å®ä¾‹çš„å¯¹æ¯”åˆ†æå’Œæœ€ç»ˆæ–¹æ¡ˆã€‚

## ğŸ¯ æ¶æ„å†³ç­–é—®é¢˜

### é—®é¢˜æè¿°
åœ¨JinBeané¡¹ç›®ä¸­ï¼ŒProviderç«¯å’ŒCustomerç«¯çš„æ•°æ®è¡¨åº”è¯¥ï¼š
- **æ–¹æ¡ˆA**: åœ¨åŒä¸€ä¸ªæ•°æ®åº“å®ä¾‹ä¸­ï¼Œä½¿ç”¨ä¸åŒçš„Schemaæˆ–è¡¨å‰ç¼€
- **æ–¹æ¡ˆB**: åˆ†æˆä¸¤ä¸ªç‹¬ç«‹çš„æ•°æ®åº“å®ä¾‹

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”åˆ†æ

### æ–¹æ¡ˆA: å•æ•°æ®åº“å®ä¾‹

#### ä¼˜åŠ¿
1. **ç®¡ç†ç®€å•**
   - å•ä¸€æ•°æ®åº“å®ä¾‹ï¼Œè¿ç»´æˆæœ¬ä½
   - ç»Ÿä¸€çš„å¤‡ä»½å’Œæ¢å¤ç­–ç•¥
   - ç»Ÿä¸€çš„ç›‘æ§å’Œå‘Šè­¦

2. **æˆæœ¬æ•ˆç›Š**
   - å‡å°‘æ•°æ®åº“å®ä¾‹è´¹ç”¨
   - å‡å°‘è¿ç»´äººåŠ›æˆæœ¬
   - å‡å°‘å­˜å‚¨æˆæœ¬

3. **æ•°æ®ä¸€è‡´æ€§**
   - è·¨ç«¯æ•°æ®äº‹åŠ¡æ”¯æŒ
   - æ•°æ®å®Œæ•´æ€§çº¦æŸ
   - é¿å…æ•°æ®åŒæ­¥é—®é¢˜

4. **æŸ¥è¯¢ä¾¿åˆ©**
   - è·¨ç«¯æ•°æ®å…³è”æŸ¥è¯¢
   - ç»Ÿä¸€çš„æ•°æ®åˆ†æ
   - ç®€åŒ–çš„æŠ¥è¡¨ç”Ÿæˆ

#### åŠ£åŠ¿
1. **å®‰å…¨éš”ç¦»**
   - æ•°æ®éš”ç¦»æ€§ç›¸å¯¹è¾ƒå¼±
   - æƒé™ç®¡ç†å¤æ‚
   - æ½œåœ¨çš„æ•°æ®æ³„éœ²é£é™©

2. **æ€§èƒ½å½±å“**
   - å•ç‚¹æ•…éšœé£é™©
   - èµ„æºç«äº‰
   - æ‰©å±•æ€§é™åˆ¶

3. **ç»´æŠ¤å¤æ‚**
   - è¡¨ç»“æ„å˜æ›´å½±å“é¢å¤§
   - ç´¢å¼•ä¼˜åŒ–å¤æ‚
   - æ€§èƒ½è°ƒä¼˜å›°éš¾

### æ–¹æ¡ˆB: å¤šæ•°æ®åº“å®ä¾‹

#### ä¼˜åŠ¿
1. **å®‰å…¨éš”ç¦»**
   - å®Œå…¨çš„æ•°æ®éš”ç¦»
   - ç‹¬ç«‹çš„æƒé™ç®¡ç†
   - é™ä½æ•°æ®æ³„éœ²é£é™©

2. **æ€§èƒ½ä¼˜åŒ–**
   - ç‹¬ç«‹çš„èµ„æºé…ç½®
   - é’ˆå¯¹æ€§çš„æ€§èƒ½è°ƒä¼˜
   - æ›´å¥½çš„å¹¶å‘å¤„ç†

3. **æ‰©å±•æ€§**
   - ç‹¬ç«‹æ‰©å±•
   - çµæ´»çš„éƒ¨ç½²ç­–ç•¥
   - å¾®æœåŠ¡æ¶æ„å‹å¥½

4. **æ•…éšœéš”ç¦»**
   - å•ç‚¹æ•…éšœå½±å“èŒƒå›´å°
   - ç‹¬ç«‹çš„æ•…éšœæ¢å¤
   - æ›´å¥½çš„å¯ç”¨æ€§

#### åŠ£åŠ¿
1. **ç®¡ç†å¤æ‚**
   - å¤šä¸ªæ•°æ®åº“å®ä¾‹ç®¡ç†
   - å¤æ‚çš„å¤‡ä»½ç­–ç•¥
   - ç›‘æ§æˆæœ¬é«˜

2. **æˆæœ¬å¢åŠ **
   - å¤šä¸ªæ•°æ®åº“å®ä¾‹è´¹ç”¨
   - è¿ç»´æˆæœ¬å¢åŠ 
   - å­˜å‚¨æˆæœ¬å¢åŠ 

3. **æ•°æ®åŒæ­¥**
   - è·¨å®ä¾‹æ•°æ®åŒæ­¥å¤æ‚
   - æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜
   - äº‹åŠ¡å¤„ç†å›°éš¾

## ğŸ— æ¨èæ–¹æ¡ˆï¼šå•æ•°æ®åº“å®ä¾‹ + Schemaéš”ç¦»

### 1. æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    JinBean Database                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  public Schema (å…¬å…±è¡¨)                                     â”‚
â”‚  â”œâ”€â”€ users (ç”¨æˆ·åŸºç¡€ä¿¡æ¯)                                   â”‚
â”‚  â”œâ”€â”€ auth (è®¤è¯ç›¸å…³)                                        â”‚
â”‚  â”œâ”€â”€ notifications (é€šçŸ¥)                                   â”‚
â”‚  â””â”€â”€ system_config (ç³»ç»Ÿé…ç½®)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  provider Schema (Providerç«¯è¡¨)                             â”‚
â”‚  â”œâ”€â”€ provider_profiles (Provideré…ç½®)                       â”‚
â”‚  â”œâ”€â”€ provider_services (ProvideræœåŠ¡)                       â”‚
â”‚  â”œâ”€â”€ provider_orders (Providerè®¢å•)                         â”‚
â”‚  â”œâ”€â”€ provider_clients (Providerå®¢æˆ·)                        â”‚
â”‚  â””â”€â”€ provider_income (Provideræ”¶å…¥)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  customer Schema (Customerç«¯è¡¨)                             â”‚
â”‚  â”œâ”€â”€ customer_profiles (Customeré…ç½®)                       â”‚
â”‚  â”œâ”€â”€ customer_orders (Customerè®¢å•)                         â”‚
â”‚  â”œâ”€â”€ customer_addresses (Customeråœ°å€)                      â”‚
â”‚  â”œâ”€â”€ customer_preferences (Customeråå¥½)                    â”‚
â”‚  â””â”€â”€ customer_reviews (Customerè¯„ä»·)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  shared Schema (å…±äº«è¡¨)                                     â”‚
â”‚  â”œâ”€â”€ orders (è®¢å•ä¸»è¡¨)                                      â”‚
â”‚  â”œâ”€â”€ services (æœåŠ¡ä¸»è¡¨)                                    â”‚
â”‚  â”œâ”€â”€ payments (æ”¯ä»˜è®°å½•)                                    â”‚
â”‚  â””â”€â”€ messages (æ¶ˆæ¯è®°å½•)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Schemaè®¾è®¡

#### public Schema (å…¬å…±è¡¨)
```sql
-- ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨
CREATE TABLE public.users (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    email text UNIQUE NOT NULL,
    phone text UNIQUE,
    display_name text NOT NULL,
    avatar text,
    status text NOT NULL DEFAULT 'active',
    user_type text NOT NULL, -- 'provider', 'customer', 'admin'
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);

-- è®¤è¯ç›¸å…³è¡¨
CREATE TABLE public.auth_sessions (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    token text NOT NULL,
    expires_at timestamptz NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

-- é€šçŸ¥è¡¨
CREATE TABLE public.notifications (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    title text NOT NULL,
    content text NOT NULL,
    type text NOT NULL, -- 'info', 'warning', 'error', 'success'
    is_read boolean DEFAULT false,
    created_at timestamptz NOT NULL DEFAULT now()
);

-- ç³»ç»Ÿé…ç½®è¡¨
CREATE TABLE public.system_config (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    config_key text UNIQUE NOT NULL,
    config_value text NOT NULL,
    description text,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);
```

#### provider Schema (Providerç«¯è¡¨)
```sql
-- åˆ›å»ºProvider Schema
CREATE SCHEMA IF NOT EXISTS provider;

-- Provideré…ç½®æ–‡ä»¶è¡¨
CREATE TABLE provider.provider_profiles (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    business_name text NOT NULL,
    business_description text,
    business_address text,
    business_phone text,
    business_email text,
    business_website text,
    service_categories text[],
    service_areas text[],
    working_hours jsonb,
    average_rating numeric DEFAULT 0,
    total_reviews integer DEFAULT 0,
    total_orders integer DEFAULT 0,
    total_income numeric DEFAULT 0,
    verification_status text DEFAULT 'pending',
    is_active boolean DEFAULT true,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE(user_id)
);

-- ProvideræœåŠ¡è¡¨
CREATE TABLE provider.provider_services (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    provider_id uuid NOT NULL REFERENCES provider.provider_profiles(id) ON DELETE CASCADE,
    service_name text NOT NULL,
    service_description text,
    service_category text NOT NULL,
    price numeric NOT NULL,
    price_type text NOT NULL DEFAULT 'fixed',
    duration_minutes integer,
    is_available boolean DEFAULT true,
    max_bookings_per_day integer,
    cancellation_policy text,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);

-- Providerå®¢æˆ·å…³ç³»è¡¨
CREATE TABLE provider.provider_clients (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    provider_id uuid NOT NULL REFERENCES provider.provider_profiles(id) ON DELETE CASCADE,
    client_user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    display_name text NOT NULL DEFAULT 'æœªçŸ¥å®¢æˆ·',
    phone text,
    email text,
    status text NOT NULL DEFAULT 'active',
    total_orders integer NOT NULL DEFAULT 0,
    total_spent numeric NOT NULL DEFAULT 0,
    average_rating numeric DEFAULT 0,
    first_order_date timestamptz,
    last_order_date timestamptz,
    last_contact_date timestamptz,
    notes text,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE(provider_id, client_user_id)
);

-- Provideræ”¶å…¥è®°å½•è¡¨
CREATE TABLE provider.provider_income_records (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    provider_id uuid NOT NULL REFERENCES provider.provider_profiles(id) ON DELETE CASCADE,
    order_id uuid NOT NULL REFERENCES shared.orders(id) ON DELETE CASCADE,
    amount numeric NOT NULL,
    commission_rate numeric DEFAULT 0.1,
    commission_amount numeric NOT NULL,
    net_amount numeric NOT NULL,
    payment_status text NOT NULL DEFAULT 'pending',
    payment_method text,
    payment_date timestamptz,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);
```

#### customer Schema (Customerç«¯è¡¨)
```sql
-- åˆ›å»ºCustomer Schema
CREATE SCHEMA IF NOT EXISTS customer;

-- Customeré…ç½®æ–‡ä»¶è¡¨
CREATE TABLE customer.customer_profiles (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    default_address text,
    preferred_categories text[],
    total_spent numeric DEFAULT 0,
    total_orders integer DEFAULT 0,
    average_rating numeric DEFAULT 0,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE(user_id)
);

-- Customeråœ°å€è¡¨
CREATE TABLE customer.customer_addresses (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    customer_id uuid NOT NULL REFERENCES customer.customer_profiles(id) ON DELETE CASCADE,
    address_type text NOT NULL, -- 'home', 'work', 'other'
    address_line1 text NOT NULL,
    address_line2 text,
    city text NOT NULL,
    state text NOT NULL,
    postal_code text NOT NULL,
    country text NOT NULL DEFAULT 'CN',
    is_default boolean DEFAULT false,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);

-- Customeråå¥½è¡¨
CREATE TABLE customer.customer_preferences (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    customer_id uuid NOT NULL REFERENCES customer.customer_profiles(id) ON DELETE CASCADE,
    preference_key text NOT NULL,
    preference_value text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE(customer_id, preference_key)
);

-- Customerè¯„ä»·è¡¨
CREATE TABLE customer.customer_reviews (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    customer_id uuid NOT NULL REFERENCES customer.customer_profiles(id) ON DELETE CASCADE,
    order_id uuid NOT NULL REFERENCES shared.orders(id) ON DELETE CASCADE,
    provider_id uuid NOT NULL REFERENCES provider.provider_profiles(id) ON DELETE CASCADE,
    rating integer NOT NULL CHECK (rating >= 1 AND rating <= 5),
    review_text text,
    is_anonymous boolean DEFAULT false,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);
```

#### shared Schema (å…±äº«è¡¨)
```sql
-- åˆ›å»ºShared Schema
CREATE SCHEMA IF NOT EXISTS shared;

-- è®¢å•ä¸»è¡¨
CREATE TABLE shared.orders (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    customer_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    provider_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    service_id uuid NOT NULL,
    status text NOT NULL DEFAULT 'pending',
    amount numeric NOT NULL,
    scheduled_date timestamptz NOT NULL,
    actual_start_date timestamptz,
    actual_end_date timestamptz,
    customer_address_id uuid,
    notes text,
    cancellation_reason text,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);

-- æœåŠ¡ä¸»è¡¨
CREATE TABLE shared.services (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    provider_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    service_name text NOT NULL,
    service_description text,
    service_category text NOT NULL,
    price numeric NOT NULL,
    price_type text NOT NULL DEFAULT 'fixed',
    duration_minutes integer,
    is_available boolean DEFAULT true,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);

-- æ”¯ä»˜è®°å½•è¡¨
CREATE TABLE shared.payments (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    order_id uuid NOT NULL REFERENCES shared.orders(id) ON DELETE CASCADE,
    amount numeric NOT NULL,
    payment_method text NOT NULL,
    payment_status text NOT NULL DEFAULT 'pending',
    transaction_id text,
    payment_date timestamptz,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);

-- æ¶ˆæ¯è®°å½•è¡¨
CREATE TABLE shared.messages (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    sender_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    receiver_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    message_type text NOT NULL DEFAULT 'text', -- 'text', 'image', 'file'
    message_content text NOT NULL,
    is_read boolean DEFAULT false,
    created_at timestamptz NOT NULL DEFAULT now()
);
```

### 3. æƒé™ç®¡ç†

#### Schemaçº§åˆ«æƒé™
```sql
-- ä¸ºä¸åŒè§’è‰²åˆ›å»ºç”¨æˆ·
CREATE USER provider_app WITH PASSWORD 'provider_password';
CREATE USER customer_app WITH PASSWORD 'customer_password';
CREATE USER admin_user WITH PASSWORD 'admin_password';

-- æˆäºˆSchemaæƒé™
GRANT USAGE ON SCHEMA public TO provider_app, customer_app, admin_user;
GRANT USAGE ON SCHEMA provider TO provider_app, admin_user;
GRANT USAGE ON SCHEMA customer TO customer_app, admin_user;
GRANT USAGE ON SCHEMA shared TO provider_app, customer_app, admin_user;

-- æˆäºˆè¡¨æƒé™
-- Provideråº”ç”¨æƒé™
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO provider_app;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA provider TO provider_app;
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA shared TO provider_app;

-- Customeråº”ç”¨æƒé™
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO customer_app;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA customer TO customer_app;
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA shared TO customer_app;

-- ç®¡ç†å‘˜æƒé™
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO admin_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA provider TO admin_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA customer TO admin_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA shared TO admin_user;
```

#### è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)
```sql
-- Providerç«¯RLSç­–ç•¥
ALTER TABLE provider.provider_profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Providers can view own profile" ON provider.provider_profiles
    FOR SELECT USING (user_id = auth.uid());
CREATE POLICY "Providers can update own profile" ON provider.provider_profiles
    FOR UPDATE USING (user_id = auth.uid());

-- Customerç«¯RLSç­–ç•¥
ALTER TABLE customer.customer_profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Customers can view own profile" ON customer.customer_profiles
    FOR SELECT USING (user_id = auth.uid());
CREATE POLICY "Customers can update own profile" ON customer.customer_profiles
    FOR UPDATE USING (user_id = auth.uid());

-- å…±äº«è¡¨RLSç­–ç•¥
ALTER TABLE shared.orders ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own orders" ON shared.orders
    FOR SELECT USING (customer_id = auth.uid() OR provider_id = auth.uid());
CREATE POLICY "Customers can create orders" ON shared.orders
    FOR INSERT WITH CHECK (customer_id = auth.uid());
CREATE POLICY "Providers can update orders" ON shared.orders
    FOR UPDATE USING (provider_id = auth.uid());
```

### 4. ç´¢å¼•è®¾è®¡

#### æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
```sql
-- ç”¨æˆ·è¡¨ç´¢å¼•
CREATE INDEX idx_users_email ON public.users(email);
CREATE INDEX idx_users_phone ON public.users(phone);
CREATE INDEX idx_users_user_type ON public.users(user_type);

-- Providerè¡¨ç´¢å¼•
CREATE INDEX idx_provider_profiles_user_id ON provider.provider_profiles(user_id);
CREATE INDEX idx_provider_profiles_verification_status ON provider.provider_profiles(verification_status);
CREATE INDEX idx_provider_services_provider_id ON provider.provider_services(provider_id);
CREATE INDEX idx_provider_services_category ON provider.provider_services(service_category);

-- Customerè¡¨ç´¢å¼•
CREATE INDEX idx_customer_profiles_user_id ON customer.customer_profiles(user_id);
CREATE INDEX idx_customer_addresses_customer_id ON customer.customer_addresses(customer_id);
CREATE INDEX idx_customer_reviews_customer_id ON customer.customer_reviews(customer_id);

-- å…±äº«è¡¨ç´¢å¼•
CREATE INDEX idx_orders_customer_id ON shared.orders(customer_id);
CREATE INDEX idx_orders_provider_id ON shared.orders(provider_id);
CREATE INDEX idx_orders_status ON shared.orders(status);
CREATE INDEX idx_orders_scheduled_date ON shared.orders(scheduled_date);
CREATE INDEX idx_payments_order_id ON shared.payments(order_id);
CREATE INDEX idx_messages_sender_receiver ON shared.messages(sender_id, receiver_id);
```

## ğŸ”„ æ•°æ®è®¿é—®å±‚è®¾è®¡

### 1. æ•°æ®åº“è¿æ¥é…ç½®
```dart
// æ•°æ®åº“è¿æ¥é…ç½®
class DatabaseConfig {
  static const String host = 'your-supabase-host';
  static const String port = '5432';
  static const String database = 'postgres';
  
  // Providerç«¯è¿æ¥
  static const String providerUser = 'provider_app';
  static const String providerPassword = 'provider_password';
  
  // Customerç«¯è¿æ¥
  static const String customerUser = 'customer_app';
  static const String customerPassword = 'customer_password';
  
  // ç®¡ç†å‘˜è¿æ¥
  static const String adminUser = 'admin_user';
  static const String adminPassword = 'admin_password';
}

// æ•°æ®åº“è¿æ¥ç®¡ç†
class DatabaseConnectionManager {
  static final Map<String, SupabaseClient> _connections = {};
  
  static SupabaseClient getProviderConnection() {
    if (!_connections.containsKey('provider')) {
      _connections['provider'] = SupabaseClient(
        DatabaseConfig.host,
        DatabaseConfig.providerPassword,
        options: SupabaseClientOptions(
          db: DatabaseConfig.database,
          schema: 'provider,shared,public',
        ),
      );
    }
    return _connections['provider']!;
  }
  
  static SupabaseClient getCustomerConnection() {
    if (!_connections.containsKey('customer')) {
      _connections['customer'] = SupabaseClient(
        DatabaseConfig.host,
        DatabaseConfig.customerPassword,
        options: SupabaseClientOptions(
          db: DatabaseConfig.database,
          schema: 'customer,shared,public',
        ),
      );
    }
    return _connections['customer']!;
  }
  
  static SupabaseClient getAdminConnection() {
    if (!_connections.containsKey('admin')) {
      _connections['admin'] = SupabaseClient(
        DatabaseConfig.host,
        DatabaseConfig.adminPassword,
        options: SupabaseClientOptions(
          db: DatabaseConfig.database,
          schema: 'provider,customer,shared,public',
        ),
      );
    }
    return _connections['admin']!;
  }
}
```

### 2. Schemaæ„ŸçŸ¥çš„æ•°æ®è®¿é—®
```dart
// Schemaæ„ŸçŸ¥çš„æ•°æ®åº“æœåŠ¡
class SchemaAwareDatabaseService {
  final SupabaseClient _client;
  final String _schema;
  
  SchemaAwareDatabaseService(this._client, this._schema);
  
  String _getTableName(String table) {
    return '$_schema.$table';
  }
  
  Future<List<Map<String, dynamic>>> query(String table, {
    String? select,
    Map<String, dynamic>? filters,
    String? orderBy,
    int? limit,
    int? offset,
  }) async {
    final tableName = _getTableName(table);
    // å®ç°æŸ¥è¯¢é€»è¾‘
  }
  
  Future<Map<String, dynamic>> insert(String table, Map<String, dynamic> data) async {
    final tableName = _getTableName(table);
    // å®ç°æ’å…¥é€»è¾‘
  }
  
  Future<void> update(String table, Map<String, dynamic> data, Map<String, dynamic> filters) async {
    final tableName = _getTableName(table);
    // å®ç°æ›´æ–°é€»è¾‘
  }
  
  Future<void> delete(String table, Map<String, dynamic> filters) async {
    final tableName = _getTableName(table);
    // å®ç°åˆ é™¤é€»è¾‘
  }
}

// Providerç«¯æ•°æ®åº“æœåŠ¡
class ProviderDatabaseService extends SchemaAwareDatabaseService {
  ProviderDatabaseService() : super(
    DatabaseConnectionManager.getProviderConnection(),
    'provider',
  );
}

// Customerç«¯æ•°æ®åº“æœåŠ¡
class CustomerDatabaseService extends SchemaAwareDatabaseService {
  CustomerDatabaseService() : super(
    DatabaseConnectionManager.getCustomerConnection(),
    'customer',
  );
}

// å…±äº«æ•°æ®åº“æœåŠ¡
class SharedDatabaseService extends SchemaAwareDatabaseService {
  SharedDatabaseService() : super(
    DatabaseConnectionManager.getProviderConnection(), // æˆ–customerè¿æ¥
    'shared',
  );
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æŸ¥è¯¢ä¼˜åŒ–
- **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
- **åˆ†åŒºè¡¨**: å¯¹å¤§æ•°æ®é‡è¡¨è¿›è¡Œåˆ†åŒº
- **æŸ¥è¯¢ç¼“å­˜**: å®ç°æŸ¥è¯¢ç»“æœç¼“å­˜
- **è¿æ¥æ± **: ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± 

### 2. ç›‘æ§å’Œå‘Šè­¦
- **æ€§èƒ½ç›‘æ§**: ç›‘æ§æŸ¥è¯¢å“åº”æ—¶é—´
- **èµ„æºç›‘æ§**: ç›‘æ§CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨
- **è¿æ¥ç›‘æ§**: ç›‘æ§æ•°æ®åº“è¿æ¥æ•°
- **é”™è¯¯ç›‘æ§**: ç›‘æ§æ•°æ®åº“é”™è¯¯

### 3. å¤‡ä»½å’Œæ¢å¤
- **è‡ªåŠ¨å¤‡ä»½**: å®šæœŸè‡ªåŠ¨å¤‡ä»½
- **å¢é‡å¤‡ä»½**: å®ç°å¢é‡å¤‡ä»½ç­–ç•¥
- **ç¾éš¾æ¢å¤**: åˆ¶å®šç¾éš¾æ¢å¤è®¡åˆ’
- **æ•°æ®å½’æ¡£**: å¯¹å†å²æ•°æ®è¿›è¡Œå½’æ¡£

## ğŸš€ å®æ–½è®¡åˆ’

### 1. ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„ (1-2å‘¨)
- åˆ›å»ºæ•°æ®åº“Schema
- å®ç°åŸºç¡€è¡¨ç»“æ„
- é…ç½®æƒé™ç®¡ç†
- å»ºç«‹ç´¢å¼•

### 2. ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®è®¿é—®å±‚ (2-3å‘¨)
- å®ç°æ•°æ®åº“è¿æ¥ç®¡ç†
- å¼€å‘Schemaæ„ŸçŸ¥çš„æ•°æ®è®¿é—®æœåŠ¡
- å®ç°åŸºç¡€CRUDæ“ä½œ
- ç¼–å†™å•å…ƒæµ‹è¯•

### 3. ç¬¬ä¸‰é˜¶æ®µï¼šåº”ç”¨é›†æˆ (2-3å‘¨)
- é›†æˆProviderç«¯åº”ç”¨
- é›†æˆCustomerç«¯åº”ç”¨
- å®ç°è·¨SchemaæŸ¥è¯¢
- æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

### 4. ç¬¬å››é˜¶æ®µï¼šç›‘æ§å’Œä¼˜åŒ– (1-2å‘¨)
- éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ
- æ€§èƒ½è°ƒä¼˜
- å®‰å…¨åŠ å›º
- æ–‡æ¡£å®Œå–„

## âœ… æ€»ç»“

### æ¨èæ–¹æ¡ˆï¼šå•æ•°æ®åº“å®ä¾‹ + Schemaéš”ç¦»

#### é€‰æ‹©ç†ç”±
1. **æˆæœ¬æ•ˆç›Š**: é™ä½è¿ç»´æˆæœ¬å’Œæ•°æ®åº“å®ä¾‹è´¹ç”¨
2. **ç®¡ç†ç®€å•**: å•ä¸€æ•°æ®åº“å®ä¾‹ï¼Œä¾¿äºç®¡ç†
3. **æ•°æ®ä¸€è‡´æ€§**: æ”¯æŒè·¨ç«¯æ•°æ®äº‹åŠ¡å’Œå…³è”æŸ¥è¯¢
4. **å®‰å…¨éš”ç¦»**: é€šè¿‡Schemaå’Œæƒé™ç®¡ç†å®ç°æ•°æ®éš”ç¦»
5. **æ‰©å±•æ€§**: æ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•

#### å…³é”®ç‰¹æ€§
- **Schemaéš”ç¦»**: é€šè¿‡Schemaå®ç°é€»è¾‘éš”ç¦»
- **æƒé™ç®¡ç†**: åŸºäºè§’è‰²çš„ç»†ç²’åº¦æƒé™æ§åˆ¶
- **è¡Œçº§å®‰å…¨**: å®ç°æ•°æ®è¡Œçº§å®‰å…¨ç­–ç•¥
- **æ€§èƒ½ä¼˜åŒ–**: é’ˆå¯¹æ€§çš„ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–
- **ç›‘æ§å‘Šè­¦**: å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»

è¿™ä¸ªæ–¹æ¡ˆåœ¨ä¿è¯æ•°æ®å®‰å…¨éš”ç¦»çš„åŒæ—¶ï¼Œæœ€å¤§åŒ–äº†æˆæœ¬æ•ˆç›Šå’Œè¿ç»´ä¾¿åˆ©æ€§ï¼Œæ˜¯JinBeané¡¹ç›®çš„æœ€ä½³é€‰æ‹©ï¼

---

**æœ€åæ›´æ–°**: 2024å¹´12æœˆ
**ç»´æŠ¤è€…**: æ•°æ®åº“æ¶æ„å›¢é˜Ÿ 